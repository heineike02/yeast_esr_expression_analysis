---
title: "R Notebook"
output: html_notebook
---
```{r}
## try http:// if https:// URLs are not supported
#source("https://bioconductor.org/biocLite.R")
#biocLite()

# I think only this one is needed once when using on a new environment
## try http:// if https:// URLs are not supported
# source("https://bioconductor.org/biocLite.R")
# biocLite("DESeq2")
# print("loaded 20181030")
```

```{r}
library(DESeq2)
library(ggplot2)
library(reshape2)
library(lattice)

base_dir = "C:\\Users\\BMH_work\\github\\yeast_esr_expression_analysis\\expression_data\\kl_sc_PKA_as_m24_r1g1_20181017\\"
print(base_dir)
```

```{r}

#Load Data 

#Filter outliers

#Run deseq on +/- drug

countDataList = list(KL = NULL,SC  = NULL)
metaDataList = list(KL = NULL,SC  = NULL)


for (exp_species in c("KL","SC")){
  print(exp_species)
  
  print(paste("species is ", exp_species))
  cts <- paste(base_dir,"20181017_countdata_postQC_",exp_species,".csv",sep = "")
  countData = read.csv(cts, row.names = 1, header = TRUE)
  
  #selecting out a subset: 
  # countData = countData[,c("7001","7002")]
     
  #this metadata file comes from the python script 20181025_sequencingQC_and_counts_file.ipynb.
  meta <- paste(base_dir,"20181017_metadata_deseq_",exp_species,".csv",sep = "")
  metaData = read.csv(meta, row.names = 1)
  
  #Remove Biological Replicates (From previous year) from analysis
  metaData_filt <-metaData[!metaData$replicate=='BR',]
  countData_filt <-countData[,!metaData$replicate=='BR']
  
  #Remove rows (genes) that have greater than Ncounts counts in Nsamp samples
  Ncounts = 2
  Nsamp = 3
  
  countData_filt <- countData_filt[(rowSums(countData_filt >=2)>3),]
  
  colnames(countData_filt) = row.names(metaData_filt)
  
  #Add column to metadata to combine tf_del, 
  
  metaData_filt$tf_del.pka_AS_mut.NMPP1 <- as.factor(paste(metaData_filt$tf_del,
        metaData_filt$pka_AS_mut,
        metaData_filt$NMPP1,sep='.'))
  
  countDataList[[exp_species]]=countData_filt
  metaDataList[[exp_species]]=metaData_filt
  
  
  # print(metaData)
  # print(countData)
  
  
  #Turns all count data into a DESeqDataSet
  #Didn't include replicate as part of the design
  #
  dds_all = DESeqDataSetFromMatrix(countData = countData_filt, 
                                   colData = metaData_filt, 
                                   design = ~ tf_del.pka_AS_mut.NMPP1)
  
  
  #Find Rlog data for all conditions/samples
  rld_all <- rlog(dds_all, blind = FALSE)  #, fitType = 'local')
  rlog_all <- assay(rld_all)
  
  write.csv(as.data.frame(rlog_all),
            file=paste(base_dir,"20200603_rlog_all_",exp_species,".csv",sep = ""))
  
  # #Plot two WT.WT.cont samples v.s. each other
  # plot(rlog_all[,"7001"],rlog_all[,"7033"])
  # 
  # #Plot RG.AS.cong rep 2 (7042) vs the tech rep RG.AS.cont 2_TRR (7076) samples v.s. each other
  # plot(rlog_all[,"7042"],rlog_all[,"7076"])
  
  
  
  dds_all <- DESeq(dds_all)
  FDR = 0.01
  plotDispEsts(dds_all)
  
  #Find DEseq for WT.AS.drug vs WT.AS.cont
  res = results(dds_all,
                contrast=c("tf_del.pka_AS_mut.NMPP1","WT.AS.drug","WT.AS.cont"), 
                alpha=FDR)
  
  #put results in order of padj
  res <- res[order(res$padj),] 
  #write.csv(as.data.frame(res), 
  #file=paste(base_dir,"20200603_deseq_",exp_species,"_AS_WT_nmpp1.csv",sep = ""))
  
  plot(res$log2FoldChange,-log10(res$padj))
  
  
  #Find DEseq for M24.AS.drug vs M24.AS.cont
  res = results(dds_all,
                contrast=c("tf_del.pka_AS_mut.NMPP1","M24.AS.drug","M24.AS.cont"), 
                alpha=FDR)
  
  #put results in order of padj
  res <- res[order(res$padj),] 
  write.csv(as.data.frame(res), 
  file=paste(base_dir,"20201003_deseq_",exp_species,"_AS_M24_nmpp1.csv",sep = ""))
  
  plot(res$log2FoldChange,-log10(res$padj))
  
}

```



```{r}
#Load raw count data for each species from experiment.

countDataList = list(KL = NULL,SC  = NULL)
metaDataList = list(KL = NULL,SC  = NULL)

#exp_species="KL"

for (exp_species in c("KL","SC")){
  print(paste("species is ", exp_species))
  cts <- paste(base_dir,"20181017_countdata_postQC_",exp_species,".csv",sep = "")
  countData = read.csv(cts, row.names = 1, header = TRUE)
  #selecting out a subset: 
  # countData = countData[,c("7001","7002")]
   
  #this metadata file comes from the python script 20181025_sequencingQC_and_counts_file.ipynb.
  meta <- paste(base_dir,"20181017_metadata_deseq_",exp_species,".csv",sep = "")
  metaData = read.csv(meta, row.names = 1)
  colnames(countData) = row.names(metaData)
  countDataList[[exp_species]]=countData
  metaDataList[[exp_species]]=metaData
  print(metaData)
  print(countData)

  #Turns all count data into a DESeqDataSet
  dds_all = DESeqDataSetFromMatrix(countData = countData, colData = metaData, design = ~pka_AS_mut+tf_del+NMPP1+replicate)
  print(dds_all)
  #If there are any rows with zero or one count, this command removes them, (in this dataset there are not)
  paste(nrow(dds_all[ rowSums(counts(dds_all)) <= 1, ]), "items removed from Kl count data because there were no counts")
  dds_all_filtered = dds_all[ rowSums(counts(dds_all)) > 1, ]

  #Finds rlog values and prints to file

  #uses all default options except blind = FALSE instead of true
  #Note from documentation:
  #If many of genes have large differences in counts due to the experimental design,it is important to set blind=FALSE for downstream analysis.

  rld_all <- rlog(dds_all_filtered, blind = FALSE)  #, fitType = 'local')
  rlog_all <- assay(rld_all)
  #head(rlog_all)
  #plot(rlog_all[,"7050"],rlog_all[,"7002"])

  #write.csv(as.data.frame(rlog_all), file=paste(base_dir,"20181017_rlog_all_",exp_species,".csv",sep = ""))


}


# klMetaData <- metaData[c("AS1_minus","AS2_minus", "WT_minus","WT_plus", "AS1_plus","AS2_plus"),]
# #Combines final two columns of metadata
# klMetaData$condition = paste(klMetaData$strain,klMetaData$NMPP1,sep="_")
# klMetaData = klMetaData[ , "condition", drop = FALSE]
# klMetaData$condition = as.factor(klMetaData$condition)  #Avoid error message since this starts as a character. 
```


```{r}
#Focus on just SC WT samples with Rph1/Gis1 deletions, no drug

samples_WT_r1g1 <- c("7001","7002","7033","7034","7057","7058")

exp_species = 'SC'

# cts <- paste(base_dir,"20181017_countdata_postQC_",exp_species,".csv",sep = "")
# countData = read.csv(cts, row.names = 1, header = TRUE)

countData = countDataList[[exp_species]]
metaData = metaDataList[[exp_species]]

countData_exp <- countData[,samples_WT_r1g1]
metaData_exp <- metaData[samples_WT_r1g1, "tf_del" ,drop = FALSE]
  
countData_exp
metaData_exp
  

dds_exp = DESeqDataSetFromMatrix(countData = countData_exp, colData = metaData_exp, design = ~tf_del)
dds_exp$tf_del <- factor(dds_exp$tf_del, levels = c("WT", "RG"))

#removing genes with no counts
paste(nrow(dds_exp[ rowSums(counts(dds_exp)) <= 1, ]), "items removed from Kl count data because there were no counts")
dds_exp_filtered = dds_exp[ rowSums(counts(dds_exp)) > 1, ]

dds_exp_out = DESeq(dds_exp_filtered)
plotDispEsts(dds_exp_out)



res = results(dds_exp_out,  alpha = 10e-100)
print(res)
plotMA(res, main = paste(exp_species,"Rph1/Gis1 Delete v.s. WT"), ylim = c(-6,6))
#Sort results and write as a .csv file
resOrdered <- res[order(res$padj),]
write.csv(as.data.frame(resOrdered), file=paste(base_dir,"20181017_deseq_",exp_species,"_WT_wtVr1g1.csv",sep = ""))


```



```{r}
#Focus on SC and KL samples in AS with Rph1/Gis1 deletions, no drug

exp_species="KL"

#for (exp_species in c("KL","SC")){

  countData = countDataList[[exp_species]]
  metaData = metaDataList[[exp_species]]

  metaData_exp = metaData[(metaData$tf_del %in% c('WT','RG')) & (metaData$pka_AS_mut == 'AS') & (metaData$NMPP1 == 'cont')& (metaData$replicate != 'BR'),c('tf_del'), drop=FALSE]

  sampleIds = row.names(metaData_exp)

  countData_exp <- countData[,sampleIds]
    
  
  dds_exp = DESeqDataSetFromMatrix(countData = countData_exp, colData = metaData_exp, design = ~tf_del)
  dds_exp$tf_del <- factor(dds_exp$tf_del, levels = c("WT", "RG"))
  
  #removing genes with no counts
  paste(nrow(dds_exp[ rowSums(counts(dds_exp)) <= 1, ]), "items removed from Kl count data because there were no counts")
  dds_exp_filtered = dds_exp[ rowSums(counts(dds_exp)) > 1, ]
  
  dds_exp_out = DESeq(dds_exp_filtered)
  plotDispEsts(dds_exp_out)
  
  
  
  res = results(dds_exp_out,  alpha = 10e-100)
  print(res)
  plotMA(res, main = paste(exp_species," Rph1/Gis1 Delete v.s. WT"), ylim = c(-6,6))
  #Sort results and write as a .csv file
  resOrdered <- res[order(res$padj),]
  write.csv(as.data.frame(resOrdered), file=paste(base_dir,"20181017_deseq_",exp_species,"_AS_wtVr1g1.csv",sep = ""))


#}

```



```{r}
#Make deseq comparison for AS +/- NMPP1 conditions

results_alpha = 10e-100
#default is actually 0.1 - why do I have it set so low?  Does it make a difference? 

#exp_species="KL"

for (exp_species in c("KL","SC")){

  # cts <- paste(base_dir,"20181017_countdata_postQC_",exp_species,".csv",sep = "")
  # countData = read.csv(cts, row.names = 1, header = TRUE)
  
  countData = countDataList[[exp_species]]
  metaData = metaDataList[[exp_species]]
  
  metaData_exp = metaData[(metaData$tf_del == 'WT') & (metaData$pka_AS_mut == 'AS') & (metaData$replicate != 'BR'),c('NMPP1'), drop=FALSE]
  
  sampleIds = row.names(metaData_exp)
  
  countData_exp <- countData[,sampleIds]
  
  #here is the main difference - the design is ~NMPP1
  dds_exp = DESeqDataSetFromMatrix(countData = countData_exp, colData = metaData_exp, design = ~NMPP1)
  dds_exp$NMPP1 <- factor(dds_exp$NMPP1, levels = c("cont", "drug"))
  
  #removing genes with 1 or 0 counts
  paste(nrow(dds_exp[ rowSums(counts(dds_exp)) <= 1, ]), "items removed from count data because there was only 1 or 0 counts")
  dds_exp_filtered = dds_exp[ rowSums(counts(dds_exp)) > 1, ]
  
  dds_exp_out = DESeq(dds_exp_filtered)
  resultsNames(dds_exp_out)
  plotDispEsts(dds_exp_out)
  
  rld <- rlog(dds_exp_filtered, blind = FALSE)  #, fitType = 'local')
  rlog_exp <- assay(rld)
  
  fname_suffix = '_AS_WT_nmpp1'
  
  write.csv(as.data.frame(rlog_exp), file=paste(base_dir,"20181017_rlog_", exp_species, fname_suffix ,".csv",sep = ""))
  
  
  #save the LFC
  res = results(dds_exp_out, alpha = results_alpha)
  print(res)
  plotMA(res)
  #Sort results and write as a .csv file
  resOrdered <- res[order(res$padj),]
  write.csv(as.data.frame(resOrdered),file=paste(base_dir,"20181017_deseq_", exp_species, fname_suffix ,".csv",sep = ""))

}

```



```{r}
#Make deseq comparison for AS del Msn24 +/- NMPP1 conditions

results_alpha = 10e-100
#default is actually 0.1 - why do I have it set so low?  Does it make a difference? 

#exp_species="KL"

for (exp_species in c("KL","SC")){

  # cts <- paste(base_dir,"20181017_countdata_postQC_",exp_species,".csv",sep = "")
  # countData = read.csv(cts, row.names = 1, header = TRUE)
  
  countData = countDataList[[exp_species]]
  metaData = metaDataList[[exp_species]]
  
  metaData_exp = metaData[(metaData$tf_del == 'M24') & (metaData$pka_AS_mut == 'AS') & (metaData$replicate != 'BR'),c('NMPP1'), drop=FALSE]
  
  sampleIds = row.names(metaData_exp)
  
  countData_exp <- countData[,sampleIds]
  
  #here is the main difference - the design is ~NMPP1
  dds_exp = DESeqDataSetFromMatrix(countData = countData_exp, colData = metaData_exp, design = ~NMPP1)
  dds_exp$NMPP1 <- factor(dds_exp$NMPP1, levels = c("cont", "drug"))
  
  #removing genes with 1 or 0 counts
  paste(nrow(dds_exp[ rowSums(counts(dds_exp)) <= 1, ]), "items removed from count data because there was only 1 or 0 counts")
  dds_exp_filtered = dds_exp[ rowSums(counts(dds_exp)) > 1, ]
  
  dds_exp_out = DESeq(dds_exp_filtered)
  resultsNames(dds_exp_out)
  plotDispEsts(dds_exp_out)
  
  rld <- rlog(dds_exp_filtered, blind = FALSE)  #, fitType = 'local')
  rlog_exp <- assay(rld)
  
  fname_suffix = '_AS_M24_nmpp1'
  
  write.csv(as.data.frame(rlog_exp), file=paste(base_dir,"20181017_rlog_", exp_species, fname_suffix ,".csv",sep = ""))
  
  
  #save the LFC
  res = results(dds_exp_out, alpha = results_alpha)
  print(res)
  plotMA(res)
  #Sort results and write as a .csv file
  resOrdered <- res[order(res$padj),]
  write.csv(as.data.frame(resOrdered),file=paste(base_dir,"20181017_deseq_", exp_species, fname_suffix ,".csv",sep = ""))

}

```



```{r}
#Make deseq comparison with interaction term for AS and msn24del strains in +/- NMPP1 conditions

results_alpha = 10e-100
#default is actually 0.1 - why do I have it set so low?  Does it make a difference? 

exp_species = "KL"

#for (exp_species in c("KL","SC")){

  # cts <- paste(base_dir,"20181017_countdata_postQC_",exp_species,".csv",sep = "")
  # countData = read.csv(cts, row.names = 1, header = TRUE)
  
  countData = countDataList[[exp_species]]
  metaData = metaDataList[[exp_species]]
  
  metaData_exp = metaData[(metaData$tf_del %in% c('WT','M24')) & (metaData$pka_AS_mut == 'AS') & (metaData$replicate != 'BR'),c('tf_del','NMPP1')]
  
  sampleIds = row.names(metaData_exp)
  
  countData_exp <- countData[,sampleIds]
  
  #here is the main difference - the design is ~tf_del + NMPP1 + tf_del:NMPP1
  dds_exp = DESeqDataSetFromMatrix(countData = countData_exp, colData = metaData_exp, design = ~tf_del + NMPP1 + tf_del:NMPP1)
  dds_exp$tf_del <- factor(dds_exp$tf_del, levels = c("WT", "M24"))
  dds_exp$NMPP1 <- factor(dds_exp$NMPP1, levels = c("cont", "drug"))
  
  #removing genes with 1 or 0 counts
  paste(nrow(dds_exp[ rowSums(counts(dds_exp)) <= 1, ]), "items removed from count data because there was only 1 or 0 counts")
  dds_exp_filtered = dds_exp[ rowSums(counts(dds_exp)) > 1, ]
  
  dds_exp_out = DESeq(dds_exp_filtered)
  resultsNames(dds_exp_out)
  plotDispEsts(dds_exp_out)
  
  rld <- rlog(dds_exp_filtered, blind = FALSE)  #, fitType = 'local')
  rlog_exp <- assay(rld)
  
  fname_suffix = '_AS_m24del_nmpp1_interaction'
  
  write.csv(as.data.frame(rlog_exp), file=paste(base_dir,"20181017_rlog_", exp_species, fname_suffix ,".csv",sep = ""))
  
  
  #save the m24del/drug interaction term LFC
  res = results(dds_exp_out, name="tf_delM24.NMPP1drug", alpha = results_alpha)
  print(res)
  plotMA(res)
  #Sort results and write as a .csv file
  resOrdered <- res[order(res$padj),]
  write.csv(as.data.frame(resOrdered),file=paste(base_dir,"20181017_deseq_", exp_species, fname_suffix ,".csv",sep = ""))

#}

```




```{r}
#Focus on just SC WT samples with Msn24 deletions, no drug

results_alpha = 10e-100
#default is actually 0.1 - why do I have it set so low?  Does it make a difference? 

exp_species = 'SC'

# cts <- paste(base_dir,"20181017_countdata_postQC_",exp_species,".csv",sep = "")
# countData = read.csv(cts, row.names = 1, header = TRUE)

countData = countDataList[[exp_species]]
metaData = metaDataList[[exp_species]]

metaData_exp = metaData[(metaData$tf_del %in% c('WT','M24')) & (metaData$pka_AS_mut == 'WT') & (metaData$NMPP1 == 'cont'),'tf_del', drop=FALSE]

sampleIds = row.names(metaData_exp)

countData_exp <- countData[,sampleIds]
  

dds_exp = DESeqDataSetFromMatrix(countData = countData_exp, colData = metaData_exp, design = ~tf_del)
dds_exp$tf_del <- factor(dds_exp$tf_del, levels = c("WT", "M24"))

#removing genes with no counts
paste(nrow(dds_exp[ rowSums(counts(dds_exp)) <= 1, ]), "items removed from Kl count data because there were no counts")
dds_exp_filtered = dds_exp[ rowSums(counts(dds_exp)) > 1, ]

dds_exp_out = DESeq(dds_exp_filtered)
plotDispEsts(dds_exp_out)


res = results(dds_exp_out,  alpha = 10e-100)
print(res)
plotMA(res, main = paste(exp_species,"Msn24 Delete v.s. WT"), ylim = c(-6,6))
#Sort results and write as a .csv file
resOrdered <- res[order(res$padj),]
write.csv(as.data.frame(resOrdered), file=paste(base_dir,"20181017_deseq_",exp_species,"_WT_wtVm24.csv",sep = ""))


```

```{r}
#Focus on AS samples in both species with Msn24 deletions, no drug

results_alpha = 10e-100
#default is actually 0.1 - why do I have it set so low?  Does it make a difference? 

exp_species="KL"
#for (exp_species in c("KL","SC")){
  
  # cts <- paste(base_dir,"20181017_countdata_postQC_",exp_species,".csv",sep = "")
  # countData = read.csv(cts, row.names = 1, header = TRUE)
  
  countData = countDataList[[exp_species]]
  metaData = metaDataList[[exp_species]]
  
  metaData_exp = metaData[(metaData$tf_del %in% c('WT','M24')) & (metaData$pka_AS_mut == 'AS') & (metaData$NMPP1 == 'cont') & (metaData$replicate != 'BR'),'tf_del', drop=FALSE]
  
  sampleIds = row.names(metaData_exp)
  
  countData_exp <- countData[,sampleIds]
    
  
  dds_exp = DESeqDataSetFromMatrix(countData = countData_exp, colData = metaData_exp, design = ~tf_del)
  dds_exp$tf_del <- factor(dds_exp$tf_del, levels = c("WT", "M24"))
  
  #removing genes with no counts
  paste(nrow(dds_exp[ rowSums(counts(dds_exp)) <= 1, ]), "items removed from Kl count data because there were no counts")
  dds_exp_filtered = dds_exp[ rowSums(counts(dds_exp)) > 1, ]
  
  dds_exp_out = DESeq(dds_exp_filtered)
  plotDispEsts(dds_exp_out)
  
  
  res = results(dds_exp_out,  alpha = 10e-100)
  print(res)
  plotMA(res, main = paste(exp_species,"Msn24 Delete v.s. WT"), ylim = c(-6,6))
  #Sort results and write as a .csv file
  resOrdered <- res[order(res$padj),]
  write.csv(as.data.frame(resOrdered), file=paste(base_dir,"20181017_deseq_",exp_species,"_AS_wtVm24.csv",sep = ""))
#}

```




```{r}
#Make deseq comparison with interaction term for WT  with Rph1Gis1 deletion, Msn24 deletion and quad deletion in S.Cer

results_alpha = 10e-100
#default is actually 0.1 - why do I have it set so low?  Does it make a difference? 

exp_species = "SC"
# cts <- paste(base_dir,"20181017_countdata_postQC_",exp_species,".csv",sep = "")
# countData = read.csv(cts, row.names = 1, header = TRUE)

countData = countDataList[[exp_species]]
metaData = metaDataList[[exp_species]]

metaData_exp = metaData[(metaData$pka_AS_mut == 'WT') & (metaData$NMPP1 == 'cont') & (metaData$replicate != 'BR'),c('tf_del'), drop=FALSE]

M24_lookup = list('WT'='WT','RG'='WT','M24'='M24','RGM24'='M24')
M24_col = c()
for (tf_del in metaData_exp$tf_del){ M24_col = append(M24_col,M24_lookup[[tf_del]]) }

RG_lookup = list('WT'='WT','RG'='RG','M24'='WT','RGM24'='RG')
RG_col = c()
for (tf_del in metaData_exp$tf_del){ RG_col = append(RG_col,RG_lookup[[tf_del]]) }

metaData_exp$M24 = M24_col
metaData_exp$RG = RG_col
metaData_exp$tf_del = NULL

sampleIds = row.names(metaData_exp)

countData_exp <- countData[,sampleIds]

#here is the main difference - the design is ~RG + M24 + RG:M24
dds_exp = DESeqDataSetFromMatrix(countData = countData_exp, colData = metaData_exp, design =  ~RG + M24 + RG:M24)
dds_exp$RG <- factor(dds_exp$RG, levels = c("WT", "RG"))
dds_exp$M24 <- factor(dds_exp$M24, levels = c("WT", "M24"))

#removing genes with 1 or 0 counts
paste(nrow(dds_exp[ rowSums(counts(dds_exp)) <= 1, ]), "items removed from count data because there was only 1 or 0 counts")
dds_exp_filtered = dds_exp[ rowSums(counts(dds_exp)) > 1, ]

dds_exp_out = DESeq(dds_exp_filtered)
resultsNames(dds_exp_out)
plotDispEsts(dds_exp_out)

rld <- rlog(dds_exp_filtered, blind = FALSE)  #, fitType = 'local')
rlog_exp <- assay(rld)

fname_suffix = '_WT_RG_M24_interaction'

write.csv(as.data.frame(rlog_exp), file=paste(base_dir,"20181017_rlog_", exp_species, fname_suffix ,".csv",sep = ""))


#save the RG/M24 interaction term LFC
res = results(dds_exp_out, name="RGRG.M24M24", alpha = results_alpha)
print(res)
plotMA(res)
#Sort results and write as a .csv file
resOrdered <- res[order(res$padj),]
write.csv(as.data.frame(resOrdered),file=paste(base_dir,"20181017_deseq_", exp_species, fname_suffix ,".csv",sep = ""))


fname_suffix = '_WT_RG_M24_RG'
#save the RG LFC
res = results(dds_exp_out, contrast=c("RG","RG","WT"), alpha = results_alpha)
print(res)
plotMA(res)
#Sort results and write as a .csv file
resOrdered <- res[order(res$padj),]
write.csv(as.data.frame(resOrdered),file=paste(base_dir,"20181017_deseq_", exp_species, fname_suffix ,".csv",sep = ""))


#save the M24 LFC
fname_suffix = '_WT_RG_M24_M24'
res = results(dds_exp_out, contrast=c("M24","M24","WT"), alpha = results_alpha)
print(res)
plotMA(res)
#Sort results and write as a .csv file
resOrdered <- res[order(res$padj),]
write.csv(as.data.frame(resOrdered),file=paste(base_dir,"20181017_deseq_", exp_species, fname_suffix ,".csv",sep = ""))

```




```{r}
#Make deseq comparison with interaction term for AS with Rph1Gis1 deletion, Msn24 deletion and quad deletion in S.Cer

results_alpha = 10e-100
#default is actually 0.1 - why do I have it set so low?  Does it make a difference? 

exp_species = "KL"

#for (exp_species in c("KL","SC")){
  # cts <- paste(base_dir,"20181017_countdata_postQC_",exp_species,".csv",sep = "")
  # countData = read.csv(cts, row.names = 1, header = TRUE)
  
  countData = countDataList[[exp_species]]
  metaData = metaDataList[[exp_species]]
  
  metaData_exp = metaData[(metaData$pka_AS_mut == 'AS') & (metaData$NMPP1 == 'cont') & (metaData$replicate != 'BR'),c('tf_del'), drop=FALSE]
  
  M24_lookup = list('WT'='WT','RG'='WT','M24'='M24','RGM24'='M24')
  M24_col = c()
  for (tf_del in metaData_exp$tf_del){ M24_col = append(M24_col,M24_lookup[[tf_del]]) }
  
  RG_lookup = list('WT'='WT','RG'='RG','M24'='WT','RGM24'='RG')
  RG_col = c()
  for (tf_del in metaData_exp$tf_del){ RG_col = append(RG_col,RG_lookup[[tf_del]]) }
  
  metaData_exp$M24 = M24_col
  metaData_exp$RG = RG_col
  metaData_exp$tf_del = NULL
  
  sampleIds = row.names(metaData_exp)
  
  countData_exp <- countData[,sampleIds]
  
  #here is the main difference - the design is ~RG + M24 + RG:M24
  dds_exp = DESeqDataSetFromMatrix(countData = countData_exp, colData = metaData_exp, design =  ~RG + M24 + RG:M24)
  dds_exp$RG <- factor(dds_exp$RG, levels = c("WT", "RG"))
  dds_exp$M24 <- factor(dds_exp$M24, levels = c("WT", "M24"))
  
  #removing genes with 1 or 0 counts
  paste(nrow(dds_exp[ rowSums(counts(dds_exp)) <= 1, ]), "items removed from count data because there was only 1 or 0 counts")
  dds_exp_filtered = dds_exp[ rowSums(counts(dds_exp)) > 1, ]
  
  dds_exp_out = DESeq(dds_exp_filtered)
  resultsNames(dds_exp_out)
  plotDispEsts(dds_exp_out)
  
  rld <- rlog(dds_exp_filtered, blind = FALSE)  #, fitType = 'local')
  rlog_exp <- assay(rld)
  
  fname_suffix = '_AS_RG_M24_interaction'
  
  write.csv(as.data.frame(rlog_exp), file=paste(base_dir,"20181017_rlog_", exp_species, fname_suffix ,".csv",sep = ""))
  
  
  #save the RG/M24 interaction term LFC
  res = results(dds_exp_out, name="RGRG.M24M24", alpha = results_alpha)
  print(res)
  plotMA(res)
  #Sort results and write as a .csv file
  resOrdered <- res[order(res$padj),]
  write.csv(as.data.frame(resOrdered),file=paste(base_dir,"20181017_deseq_", exp_species, fname_suffix ,".csv",sep = ""))
  
  
  fname_suffix = '_AS_RG_M24_RG'
  #save the RG LFC
  res = results(dds_exp_out, contrast=c("RG","RG","WT"), alpha = results_alpha)
  print(res)
  plotMA(res)
  #Sort results and write as a .csv file
  resOrdered <- res[order(res$padj),]
  write.csv(as.data.frame(resOrdered),file=paste(base_dir,"20181017_deseq_", exp_species, fname_suffix ,".csv",sep = ""))
  
  
  #save the M24 LFC
  fname_suffix = '_AS_RG_M24_M24'
  res = results(dds_exp_out, contrast=c("M24","M24","WT"), alpha = results_alpha)
  print(res)
  plotMA(res)
  #Sort results and write as a .csv file
  resOrdered <- res[order(res$padj),]
  write.csv(as.data.frame(resOrdered),file=paste(base_dir,"20181017_deseq_", exp_species, fname_suffix ,".csv",sep = ""))
#}
```



```{r}
# #This raw count data will be easier for me to do in python.  
# #Normalize raw count data using median of ratios method from DESEQ and compare with rlog data
# 
# #with a pseudo count 
# #klCountData_psuedo <- klCountData + 1/2
# #KiR <- apply(klCountData_psuedo,1,function(x) (prod(x))^(1/ncol(klCountData_psuedo)))
# #Kij_KiR  <- apply(klCountData_psuedo,2,function(x) x/KiR)
# 
# #Without a pseudo count
# KiR <- apply(klCountData,1,function(x) (prod(x))^(1/ncol(klCountData)))
# Kij_KiR  <- apply(klCountData,2,function(x) x/KiR)
# 
# #Visualizing histogram of each gene's ratio before picking the median. 
# Kij_KiR_melted <- melt(as.data.frame(Kij_KiR))
# ggplot(Kij_KiR_melted,aes(x = value)) + 
#     facet_wrap(~variable) + 
#     geom_histogram(binwidth = 0.1) +
#     coord_cartesian(xlim = c(0, 6)) 
# #WT Plus has a tighter distribution of counts - and that means that the sum which I was normalizing by before doesn't correlate well with the median of ratios. 
# sj <- apply(Kij_KiR,2, function(x) median(x,na.rm = TRUE))
# klCountData_norm <- t(apply(klCountData,1, function(x) x/sj))
# # scatterplot matrix 
# splom(klCountData_norm, 
#   	main="KL data",
#   	pscales = 0)
# 
# par(mfrow=c(2,3))
# xlabels = c("AS1_minus","AS1_minus", "WT_minus")
# ylabels = c("AS2_minus","AS1_plus", "WT_plus")
# for (jj in c(1:length(xlabels))){
#     plot(klCountData_norm[,xlabels[jj]],klCountData_norm[,ylabels[jj]], xlab = "",  ylab = ylabels[jj])
# }
# for (jj in c(1:length(xlabels))){
#     plot(rlog_all[,xlabels[jj]],rlog_all[,ylabels[jj]],xlab = xlabels[jj], ylab = ylabels[jj])
# }
# 
# write.csv(as.data.frame(klCountData_norm), 
#           file="C:/Users/Ben/Documents/GitHub/expression_broad_data/expression_data/kl_PKA_as_20160824/norm_KLacdata.csv")
```



Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).